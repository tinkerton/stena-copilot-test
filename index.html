<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Contoso Sample Web Chat</title>
  <!-- your styles here -->
</head>
<body>
  <div id="global-settings">
    <select id="language-select" title="Select language">
      <option value="en-GB">English</option>
      <option value="sv-SE">Svenska</option>
      <option value="nl-NL">Nederlands</option>
      <option value="pl-PL">Polski</option>
    </select>
    <select id="market-select" title="Select market">
      <option value="uk">UK</option>
      <option value="ie">IE</option>
      <option value="se">SE</option>
      <option value="nl">NL</option>
      <option value="pl">PL</option>
    </select>
  </div>

  <div id="chat-wrapper">
    <div id="chat-header"><h1>Stina 2.0</h1></div>
    <div id="webchat" role="main"></div>
  </div>

  <button id="chat-button">Open Chat</button>

  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <script>
  (async function() {
    // 1) Element references
    const languageSelect = document.getElementById('language-select');
    const marketSelect   = document.getElementById('market-select');
    const webchatDiv     = document.getElementById('webchat');
    const chatButton     = document.getElementById('chat-button');
    const chatWrapper    = document.getElementById('chat-wrapper');

    // 2) StyleOptions + StyleSet
    const styleOptions = { hideUploadButton: true };
    const styleSet     = WebChat.createStyleSet(styleOptions);

    // 3) Token endpoint URL (exact as yours)
    const tokenEndpointURL = new URL(
      'https://157c0ba005bf48ddb4295b82e6a597.6b.environment.api.powerplatform.com/' +
      'powervirtualagents/botsbyschema/cre45_stinaCopilotPoc/directline/token?' +
      'api-version=2022-03-01-preview'
    );
    const apiVersion = tokenEndpointURL.searchParams.get('api-version');

    // 4) Helper to (re)create the chat
    async function createChat(locale, marketCode) {
      // a) Clear UI
      webchatDiv.innerHTML = '';

      // b) Tear down old DirectLine if any
      if (window.currentDirectLine) {
        window.currentDirectLine.end();
      }

      // c) Fetch region-specific endpoint & token
      const [regional, tokenResp] = await Promise.all([
        fetch(
          new URL(`/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`, tokenEndpointURL)
        ).then(r => r.json()),
        fetch(tokenEndpointURL).then(r => r.json())
      ]);

      const directLineURL = regional.channelUrlsById.directline;  // e.g. ".../v3/directline"
      const token         = tokenResp.token;

      // d) New DirectLine instance
      const dl = WebChat.createDirectLine({
        domain:  new URL('v3/directline', directLineURL),
        token
      });
      window.currentDirectLine = dl;

      // e) On connect, start + set context
      dl.connectionStatus$.subscribe(({ value }) => {
        if (value === 2) {
          dl.postActivity({
            type: 'event',
            name: 'startConversation',
            locale,
            localTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone
          }).subscribe();

          dl.postActivity({
            type: 'event',
            name: 'pvaSetContext',
            value: { marketCode, userLocale: locale }
          }).subscribe();
        }
      });

      // f) Render Web Chat
      WebChat.renderWebChat(
        { directLine: dl, locale, styleOptions, styleSet },
        webchatDiv
      );
    }

    // 5) Initial load
    await createChat(
      languageSelect.value,
      marketSelect.value
    );

    // 6) Show/hide logic (optional)
    chatButton.addEventListener('click', () => {
      chatWrapper.style.display = 'block';
      chatButton.style.display  = 'none';
    });
    document.addEventListener('click', e => {
      if (
        chatWrapper.style.display === 'block' &&
        !chatWrapper.contains(e.target) &&
        !chatButton.contains(e.target)
      ) {
        chatWrapper.style.display = 'none';
        chatButton.style.display  = 'inline-block';
      }
    });

    // 7) Language switch → fresh chat
    languageSelect.addEventListener('change', () => {
      createChat(languageSelect.value, marketSelect.value);
    });

    // 8) Market switch → just update context
    marketSelect.addEventListener('change', () => {
      if (window.currentDirectLine) {
        window.currentDirectLine.postActivity({
          type: 'event',
          name: 'pvaSetContext',
          value: { marketCode: marketSelect.value }
        }).subscribe();
      }
    });
  })();
  </script>
</body>
</html>
