<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>(ENG) Stena Line Stina 2.0 Web Chat</title>
    <style>
      /* Page background */
      html, body { height: 100%; margin: 0; }
      .background { background: url('stenaline-website.png') no-repeat top center; background-size: 100% auto; width: 100%; aspect-ratio: 3220 / 11844; }

      /* Global settings dropdowns */
      #global-settings {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        z-index: 1000;
      }
      #global-settings select { height: 30px; font-size: 14px; }

      /* Chat wrapper */
      #chat-wrapper {
        display: none;
        position: fixed;
        bottom: 50px;
        right: 50px;
        width: 375px;
        height: 600px;
        border: 1px solid #ccc;
        border-radius: 8px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 500;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      }
      /* Chat header */
      #chat-header {
        background-color: #004a93;
        color: white;
        height: 50px;
        display: flex;
        align-items: center;
        padding: 0 20px;
      }
      #chat-header h1 { margin: 0; font-size: 16px;}

      /* Web Chat container, hide horizontal overflow */
      #webchat { height: calc(100% - 50px); overflow-x: hidden; }

      /* Chat toggle button */
      #chat-button {
        position: fixed;
        bottom: 50px;
        right: 50px;
        width: 50px;
        height: 50px;
        background-color: #004a93;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
      }
      #chat-button img { width: 24px; height: 24px; }
    </style>
  </head>
  <body class="background">
    <!--<div id="global-settings">
      <select id="language-select" title="Select language">
        <option value="en-GB">English</option>
        <option value="sv-SE">Svenska</option>
        <option value="nl-NL">Nederlands</option>
        <option value="pl-PL">Polski</option>
    </select>
      <select id="market-select" title="Select market">
        <option value="uk">UK</option>
        <option value="ie">IE</option>
        <option value="se">SE</option>
        <option value="nl">NL</option>
        <option value="pl">PL</option>
      </select>
    </div>-->

    <div id="chat-wrapper">
      <div id="chat-header"><h1>Stina 2.0 - English</h1></div>
      <div id="webchat" role="main"></div>
    </div>

    <button id="chat-button" aria-label="Open chat"><img src="chaticon.png" alt="Chat icon"/></button>

    <script crossorigin="anonymous" src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <script>
      (async function() {

        // LANGUAGE
        const CHAT_LANGUAGE = "en-GB";
        const CHAT_MARKET = "uk";

         // UI handlers
        const chatButton = document.getElementById('chat-button');
        const chatWrapper = document.getElementById('chat-wrapper');
       // const languageSelect = document.getElementById('language-select');
       // const marketSelect = document.getElementById('market-select');

        const styleOptions = {"accent":"#004A93","autoScrollSnapOnPage":true,"autoScrollSnapOnPageOffset":0,"avatarBorderRadius":"0%","avatarSize":30,"backgroundColor":"suggestedActionLayout#FFFFFFFF","botAvatarBackgroundColor":"#FFFFFFFF","botAvatarImage":"https://lobster-static-upload-production.s3.eu-west-1.amazonaws.com/avatars%0A%0A/5db9430ac789d0004f198f9e/f1c24112-21ee-438f-810b-cb84bcbb9a16.png","botAvatarInitials":"","bubbleAttachmentMaxWidth":480,"bubbleAttachmentMinWidth":250,"bubbleBackground":"#EEEEEEFF","bubbleBorderColor":"#FFFFFFFF","bubbleBorderRadius":11,"bubbleBorderStyle":"solid","bubbleBorderWidth":1,"bubbleFromUserBackground":"#004A93FF","bubbleFromUserBorderColor":"#FFFFFFFF","bubbleFromUserBorderRadius":11,"bubbleFromUserBorderStyle":"solid","bubbleFromUserBorderWidth":1,"bubbleFromUserNubOffset":0,"bubbleFromUserNubSize":0,"bubbleFromUserTextColor":"#FFFFFFFF","bubbleImageHeight":10,"bubbleImageMaxHeight":240,"bubbleImageMinHeight":240,"bubbleMessageMaxWidth":480,"bubbleMessageMinWidth":120,"bubbleMinHeight":50,"bubbleNubOffset":0,"bubbleTextColor":"#333333FF","emojiSet":true,"fontSizeSmall":"70%","hideUploadButton":true,"messageActivityWordBreak":"break-word","monospaceFont":"Consolas","paddingRegular":10,"paddingWide":10,"primaryFont":null,"sendBoxBackground":"#FFFFFFFF","sendBoxBorderTop":"solid 1px ","sendBoxButtonColor":"#004A93","sendBoxButtonColorOnHover":"#004284","sendBoxButtonShadeBorderRadius":40,"sendBoxButtonShadeColorOnHover":"","sendBoxHeight":60,"sendBoxPlaceholderColor":"#191919","sendBoxTextColor":"#333333FF","showAvatarInGroup":"status","spinnerAnimationHeight":16,"spinnerAnimationPadding":12,"spinnerAnimationWidth":16,"subtleColor":"#333333FF","suggestedActionBackgroundColor":"#FFFFFFFF","suggestedActionBackgroundColorOnHover":"#004A93","suggestedActionBorderColor":"#E6E6E6FF","suggestedActionBorderRadius":0,"suggestedActionBorderWidth":1,"suggestedActionLayout":"flow","suggestedActionTextColor":"#333333FF","typingAnimationBackgroundImage":"url('https://copilotstudiokit-dev.crm.dynamics.com/WebResources/cat_/powercat/img/loadingdots.gif')","typingAnimationDuration":5000,"typingAnimationHeight":20,"typingAnimationWidth":64,"userAvatarBackgroundColor":"#FFFFFFFF","userAvatarImage":"","userAvatarInitials":""};
        const styleSet = WebChat.createStyleSet(styleOptions);

        
        // Fetch token & DirectLine URL
        const tokenEndpointURL = new URL(
          'https://157c0ba005bf48ddb4295b82e6a597.6b.environment.api.powerplatform.com/powervirtualagents/botsbyschema/creba_stina20/directline/token?api-version=2022-03-01-preview'
        );
        const apiVersion = tokenEndpointURL.searchParams.get('api-version');
        const [directLineURL, token] = await Promise.all([
          fetch(new URL(`/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`, tokenEndpointURL))
            .then(r => r.json()).then(j => j.channelUrlsById.directline),
          fetch(tokenEndpointURL).then(r => r.json()).then(j => j.token)
        ]);

        // Initialize DirectLine
       
        const directLine = WebChat.createDirectLine({ domain: new URL('v3/directline', directLineURL), token });

        function postActivityAsync(directLine, activity) {
          return new Promise((resolve, reject) => {
            directLine.postActivity(activity).subscribe({
              next: id   => resolve(id),
              error: err => reject(err)
            });
          });
        }

// Wait for the bot to connect, then set context *then* startConversation
directLine.connectionStatus$.subscribe(status => {
  if (status !== 2) return;           // only run when “Online”

  (async () => {
    try {
      // 1️⃣ Send marketCode and wait for it to succeed. This variable is IMPORTANT to send!
      await postActivityAsync(directLine, {
        type: 'event',
        name: 'pvaSetContext',
        value: { marketCode: CHAT_MARKET }
      });
      console.log('pvaSetContext sent');

      // 2️⃣ Once that’s done, fire off startConversation
      await postActivityAsync(directLine, {
        type: 'event',
        name: 'startConversation',
        locale: CHAT_LANGUAGE,
        localTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      });
      console.log('startConversation sent');
    } catch (err) {
      console.error('Chat initialization failed:', err);
    }
  })();
});
        // Render Web Chat
        WebChat.renderWebChat({ directLine, locale: CHAT_LANGUAGE, styleOptions, styleSet }, document.getElementById('webchat'));

        // Toggle chat visibility
        chatButton.addEventListener('click', () => { chatWrapper.style.display = 'block'; chatButton.style.display = 'none'; });
        document.addEventListener('click', e => {
          if (chatWrapper.style.display === 'block' && !chatWrapper.contains(e.target) && !chatButton.contains(e.target)) {
            chatWrapper.style.display = 'none'; chatButton.style.display = 'flex';
          }
        });

  })();

        
    </script>
  </body>
</html>
