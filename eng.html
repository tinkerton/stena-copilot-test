<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stina</title>
    <style>
      /* Regular */
      @font-face {
        font-family: "StenaLineSans";
        src: url("fonts/StenaSans-Regular.woff2") format("woff2"),
             url("fonts/StenaSans-Regular.woff") format("woff");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
    
      /* Regular Italic */
      @font-face {
        font-family: "StenaLineSans";
        src: url("fonts/StenaSans-RegularItalic.woff2") format("woff2");
        font-weight: 400;
        font-style: italic;
        font-display: swap;
      }
    
      /* Light */
      @font-face {
        font-family: "StenaLineSans";
        src: url("fonts/StenaSans-Light.woff2") format("woff2");
        font-weight: 300;
        font-style: normal;
        font-display: swap;
      }
    
      /* Light Italic */
      @font-face {
        font-family: "StenaLineSans";
        src: url("fonts/StenaSans-LightItalic.woff2") format("woff2");
        font-weight: 300;
        font-style: italic;
        font-display: swap;
      }
    
      /* Medium */
      @font-face {
        font-family: "StenaLineSans";
        src: url("fonts/StenaSans-Medium.woff2") format("woff2");
        font-weight: 500;
        font-style: normal;
        font-display: swap;
      }
    
      /* Medium Italic */
      @font-face {
        font-family: "StenaLineSans";
        src: url("fonts/StenaSans-MediumItalic.woff2") format("woff2");
        font-weight: 500;
        font-style: italic;
        font-display: swap;
      }
    
      /* Bold */
      @font-face {
        font-family: "StenaLineSans";
        src: url("fonts/StenaSans-Bold.woff2") format("woff2");
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
    
      /* Bold Italic */
      @font-face {
        font-family: "StenaLineSans";
        src: url("fonts/StenaSans-BoldItalic.woff2") format("woff2");
        font-weight: 700;
        font-style: italic;
        font-display: swap;
      }
    
      /* Bold Condensed */
      @font-face {
        font-family: "StenaLineSansCondensed";
        src: url("fonts/StenaSans-BoldCondensed.woff2") format("woff2");
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
    
      /* Optional: Icon font */
      @font-face {
        font-family: "StenaLineIcons";
        src: url("fonts/stenaline-icon.woff") format("woff");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }
    
      /* Example usage */
      body {
        font-family: "StenaLineSans", Arial, sans-serif;
      }
    </style>
    <style>
      /* Page background */
      html, body { height: 100%; margin: 0; }
      .background { background: url('stenaline-website.png') no-repeat top center; background-size: 100% auto; width: 100%; aspect-ratio: 3220 / 11844; }

      /* Global settings dropdowns */
      #global-settings {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        z-index: 1000;
      }
      #global-settings select { height: 30px; font-size: 14px; }

      /* Chat wrapper */
      #chat-wrapper {
        display: none;
        position: fixed;
        bottom: 50px;
        right: 50px;
        width: 375px;
        height: 600px;
        border: 1px solid #ccc;
        border-radius: 8px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 500;
        font-size: 15px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      }
      /* Chat header */
      #chat-header {
        background-color: #004a93;
        color: white;
        height: 50px;
        display: flex;
        align-items: center;
        padding: 0 20px;
      }
      #chat-header h1 { margin: 0; font-size: 14px; font-weight: 400;}

      /* Web Chat container, hide horizontal overflow */
      #webchat { height: calc(100% - 50px); overflow-x: hidden; }
      #webchat .webchat__suggested-actions__flow-box {
        justify-content: flex-end !important;
        display: flex;
      }

      /* Chat toggle button */
      #chat-button {
        position: fixed;
        bottom: 50px;
        right: 50px;
        width: 50px;
        height: 50px;
        background-color: #004a93;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
      }
      #chat-button img { width: 24px; height: 24px; }
    </style>
  </head>
  <body class="background">
  
    <div id="chat-wrapper">
      <div id="chat-header"><h1>Stina 2.0 - English</h1></div>
      <div id="webchat" role="main"></div>
    </div>

    <button id="chat-button" aria-label="Open chat"><img src="chaticon.png" alt="Chat icon"/></button>

    <script crossorigin="anonymous" src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <script>
      (async function() {

        // LANGUAGE
        const CHAT_LANGUAGE = "en-GB";
        const CHAT_MARKET = "uk";

         // UI handlers
        const chatButton = document.getElementById('chat-button');
        const chatWrapper = document.getElementById('chat-wrapper');

       const styleOptions = {
    // ===== Brand & Accents =====
    accent: "#004A93",
    subtleColor: "#333",
    backgroundColor: "#FFF",
    

    // ===== Typography =====
    primaryFont: "StenaLineSans, Arial, sans-serif",
    monospaceFont: null,
    fontSizeSmall: "70%",
    messageActivityWordBreak: "break-word",

    // ===== Layout & Padding =====
    paddingRegular: 10,
    paddingWide: 10,
    autoScrollSnapOnPage: true,
    autoScrollSnapOnPageOffset: 0,

    // ===== Avatars =====
    avatarSize: 20,
    avatarBorderRadius: "0%", // e.g. "50%" for round
    showAvatarInGroup: "status",

    // Bot avatar
    botAvatarBackgroundColor: "#FFF",
    botAvatarImage:
      "https://lobster-static-upload-production.s3.eu-west-1.amazonaws.com/avatars%0A%0A/5db9430ac789d0004f198f9e/f1c24112-21ee-438f-810b-cb84bcbb9a16.png",
    botAvatarInitials: "",

    // User avatar
    userAvatarBackgroundColor: "#FFF",
    userAvatarImage: "",
    userAvatarInitials: "",

    // ===== Message Bubbles =====
    bubbleMinHeight: 50,
    bubbleMessageMinWidth: 120,
    bubbleMessageMaxWidth: 480,

    // Attachments inside bubbles
    bubbleAttachmentMinWidth: 250,
    bubbleAttachmentMaxWidth: 480,

    // Images inside bubbles
    bubbleImageHeight: 10,     // reserved height for layout, not max
    bubbleImageMinHeight: 240,
    bubbleImageMaxHeight: 240,

    // Bubble visuals, bot side
    bubbleBackground: "#FFF",
    bubbleTextColor: "#333",
    bubbleBorderColor: "#EEE",
    bubbleBorderStyle: "solid",
    bubbleBorderWidth: 0,
    bubbleBorderRadius: 10,
    bubbleNubOffset: 0,

    // Bubble visuals, user side
    bubbleFromUserBackground: "#cae2fb",
    bubbleFromUserTextColor: "#333",
    bubbleFromUserBorderColor: "#cae2fb",
    bubbleFromUserBorderStyle: "solid",
    bubbleFromUserBorderWidth: 0,
    bubbleFromUserBorderRadius: 10,
    bubbleFromUserNubOffset: 0,
    bubbleFromUserNubSize: 0,

    // ===== Send Box =====
    sendBoxHeight: 60,
    sendBoxBackground: "#FFF",
    sendBoxTextColor: "#333",
    sendBoxPlaceholderColor: "#191919",
    sendBoxBorderTop: "solid 1px ",

    // Send button
    sendBoxButtonColor: "#004A93",
    sendBoxButtonColorOnHover: "#004284",
    sendBoxButtonShadeBorderRadius: 40,
    sendBoxButtonShadeColorOnHover: "",

    // ===== Suggested Actions =====
    suggestedActionLayout: "flow",
    suggestedActionBackgroundColor: "#FFF",
    suggestedActionBackgroundColorOnHover: "#cae2fb",
    suggestedActionBorderColor: "#cae2fb",
    suggestedActionBorderStyle: "solid",
    suggestedActionHeight: 30,
    suggestedActionBorderWidth: 1,
    suggestedActionBorderRadius: 8,
    suggestedActionTextColor: "#333",

    // ===== Typing & Spinner =====
    typingAnimationBackgroundImage:
      "url('https://copilotstudiokit-dev.crm.dynamics.com/WebResources/cat_/powercat/img/loadingdots.gif')",
    typingAnimationDuration: 5000,
    typingAnimationHeight: 20,
    typingAnimationWidth: 64,

    spinnerAnimationHeight: 16,
    spinnerAnimationWidth: 16,
    spinnerAnimationPadding: 12,

    // ===== Misc =====
    emojiSet: true,
    hideUploadButton: true
  }; 
       
       
  const styleSet = WebChat.createStyleSet(styleOptions);

  // ===== Suggested Actions =====
  styleSet.suggestedAction = {
    ...styleSet.suggestedAction,
    fontSize: '12px',
    fontFamily: 'StenaLineSans, Arial, sans-serif',
    
    // Control the bubble/button size
    padding: '5px 10px',   // top/bottom 10px, left/right 20px
  };
  
  styleSet.suggestedActionPressed = {
    ...styleSet.suggestedActionPressed,
    fontSize: '12px',
    fontFamily: 'StenaLineSans, Arial, sans-serif',

     // Control the bubble/button size
     padding: '4px 8px',   // top/bottom 10px, left/right 20px
  };

  // ===== Chat Bubbles (from bot) =====
  styleSet.messageActivity = {
    ...styleSet.messageActivity,
    fontSize: '15px',
    fontFamily: 'StenaLineSans, Arial, sans-serif'
  };

  // ===== Chat Bubbles (from user) =====
  styleSet.messageActivityFromUser = {
    ...styleSet.messageActivityFromUser,
    fontSize: '15px',
    fontFamily: 'StenaLineSans, Arial, sans-serif'
  };

  // ===== Send Box =====
  styleSet.sendBoxTextArea = {
    ...styleSet.sendBoxTextArea,
    fontSize: '15px',
    fontFamily: 'StenaLineSans, Arial, sans-serif'
  };

  // If you also want the placeholder text styled:
  styleSet.sendBoxPlaceholder = {
    ...styleSet.sendBoxPlaceholder,
    fontSize: '14px',
    fontFamily: 'StenaLineSans, Arial, sans-serif'
  };

        
        // Fetch token & DirectLine URL
        const tokenEndpointURL = new URL(
          'https://157c0ba005bf48ddb4295b82e6a597.6b.environment.api.powerplatform.com/powervirtualagents/botsbyschema/creba_stina20/directline/token?api-version=2022-03-01-preview'
        );
        const apiVersion = tokenEndpointURL.searchParams.get('api-version');
        const [directLineURL, token] = await Promise.all([
          fetch(new URL(`/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`, tokenEndpointURL))
            .then(r => r.json()).then(j => j.channelUrlsById.directline),
          fetch(tokenEndpointURL).then(r => r.json()).then(j => j.token)
        ]);

        // Initialize DirectLine
       
        const directLine = WebChat.createDirectLine({ domain: new URL('v3/directline', directLineURL), token });

        function postActivityAsync(directLine, activity) {
          return new Promise((resolve, reject) => {
            directLine.postActivity(activity).subscribe({
              next: id   => resolve(id),
              error: err => reject(err)
            });
          });
        }

// Wait for the bot to connect, then set context *then* startConversation
directLine.connectionStatus$.subscribe(status => {
  if (status !== 2) return;           // only run when “Online”

  (async () => {
    try {
      // 1 Send marketCode and wait for it to succeed. This variable is IMPORTANT to send!
      await postActivityAsync(directLine, {
        type: 'event',
        name: 'pvaSetContext',
        value: { marketCode: CHAT_MARKET }
      });
      console.log('pvaSetContext sent');

      // 2️ Once that’s done, fire off startConversation
      await postActivityAsync(directLine, {
        type: 'event',
        name: 'startConversation',
        locale: CHAT_LANGUAGE,
        localTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      });
      console.log('startConversation sent');
    } catch (err) {
      console.error('Chat initialization failed:', err);
    }
  })();
});
        // Render Web Chat
        WebChat.renderWebChat({ directLine, locale: CHAT_LANGUAGE, styleOptions, styleSet }, document.getElementById('webchat'));

        // Toggle chat visibility
        chatButton.addEventListener('click', () => { chatWrapper.style.display = 'block'; chatButton.style.display = 'none'; });
        document.addEventListener('click', e => {
          if (chatWrapper.style.display === 'block' && !chatWrapper.contains(e.target) && !chatButton.contains(e.target)) {
            chatWrapper.style.display = 'none'; chatButton.style.display = 'flex';
          }
        });

  })();

        
    </script>
  </body>
</html>
